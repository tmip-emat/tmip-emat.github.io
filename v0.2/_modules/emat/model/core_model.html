

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>emat.model.core_model &mdash; TMIP-EMAT 0.2.7, November 2019 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script type="text/javascript" src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/tmip_emat.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> TMIP-EMAT
          

          
          </a>

          
            
            
              <div class="version">
                0.2.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.intro.html">Introduction to EMAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.install.html">Installation and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.scope/index.html">Exploratory Scoping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.models/index.html">Core Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.metamodels/index.html">Meta Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.database/index.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TMIP-EMAT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>emat.model.core_model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for emat.model.core_model</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; core_model.py - define coure model API&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">ema_workbench.em_framework.model</span> <span class="k">import</span> <span class="n">AbstractModel</span> <span class="k">as</span> <span class="n">AbstractWorkbenchModel</span>
<span class="kn">from</span> <span class="nn">ema_workbench.em_framework.evaluators</span> <span class="k">import</span> <span class="n">BaseEvaluator</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Iterable</span>

<span class="kn">from</span> <span class="nn">..database.database</span> <span class="k">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">..scope.scope</span> <span class="k">import</span> <span class="n">Scope</span>
<span class="kn">from</span> <span class="nn">..optimization.optimization_result</span> <span class="k">import</span> <span class="n">OptimizationResult</span>
<span class="kn">from</span> <span class="nn">..optimization</span> <span class="k">import</span> <span class="n">EpsilonProgress</span><span class="p">,</span> <span class="n">ConvergenceMetrics</span><span class="p">,</span> <span class="n">SolutionCount</span>
<span class="kn">from</span> <span class="nn">..util.evaluators</span> <span class="k">import</span> <span class="n">prepare_evaluator</span>

<span class="kn">from</span> <span class="nn">.._pkg_constants</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">..util.loggers</span> <span class="k">import</span> <span class="n">get_module_logger</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">get_module_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="AbstractCoreModel"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel">[docs]</a><span class="k">class</span> <span class="nc">AbstractCoreModel</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">AbstractWorkbenchModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An interface for using a model with EMAT.</span>

<span class="sd">    Individual models should be instantiated using derived</span>
<span class="sd">    subclasses of this abstract base class, and not using</span>
<span class="sd">    this class directly.</span>

<span class="sd">    Args:</span>
<span class="sd">        configuration: The configuration for this</span>
<span class="sd">            core model. This can be passed as a dict, or as a str</span>
<span class="sd">            which gives the filename of a YAML file that will be</span>
<span class="sd">            loaded. If there is no configuration, giving None is</span>
<span class="sd">            also acceptable.</span>
<span class="sd">        scope (Scope or str): The exploration scope, as a Scope object or as</span>
<span class="sd">            a str which gives the filename of a YAML file that will be</span>
<span class="sd">            loaded.</span>
<span class="sd">        safe: Load the configuration YAML file in &#39;safe&#39; mode.</span>
<span class="sd">            This can be disabled if the configuration requires</span>
<span class="sd">            custom Python types or is otherwise not compatible with</span>
<span class="sd">            safe mode. Loading configuration files with safe mode</span>
<span class="sd">            off is not secure and should not be done with files from</span>
<span class="sd">            untrusted sources.</span>
<span class="sd">        db: An optional Database to store experiments and results.</span>
<span class="sd">        name: A name for this model, given as an alphanumeric string.</span>
<span class="sd">            The name is required by ema_workbench operations.</span>
<span class="sd">            If not given, &quot;EMAT&quot; is used.</span>
<span class="sd">        metamodel_id: An identifier for this model, if it is a meta-model.</span>
<span class="sd">            Defaults to 0 (i.e., not a meta-model).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">configuration</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Mapping</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span>
                 <span class="n">scope</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Scope</span><span class="p">,</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">safe</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">db</span><span class="p">:</span><span class="n">Database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;EMAT&#39;</span><span class="p">,</span>
                 <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
                    <span class="n">configuration</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">configuration</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">configuration</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span> <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">Scope</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

        <span class="n">AbstractWorkbenchModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_x_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_l_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_c_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcomes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_m_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">metamodel_id</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># don&#39;t pickle the db connection</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;db&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="AbstractCoreModel.setup"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.setup">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the core model with the experiment variable values</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            params (dict): experiment variables including both exogenous </span>
<span class="sd">                uncertainty and policy levers</span>
<span class="sd">                </span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: if experiment variable defined is not supported</span>
<span class="sd">                by the core model        </span>
<span class="sd">        &quot;&quot;&quot;</span>     </div>
 
<div class="viewcode-block" id="AbstractCoreModel.get_experiment_archive_path"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.get_experiment_archive_path">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_experiment_archive_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns path to store model run outputs</span>
<span class="sd">        </span>
<span class="sd">        Can be useful for long model runs if additional measures will be</span>
<span class="sd">        defined at a later time (e.g. link volumes). </span>
<span class="sd">        </span>
<span class="sd">        Both the scope name and experiment id can be used to create the </span>
<span class="sd">        folder path. </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            experiment_id (int):</span>
<span class="sd">                experiment id integer (row id of experiment in database)</span>
<span class="sd">                </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: model result path (no trailing backslashes)</span>
<span class="sd">        &quot;&quot;&quot;</span>     </div>
    
<div class="viewcode-block" id="AbstractCoreModel.run"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.run">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates the core model run</span>
<span class="sd">        </span>
<span class="sd">        Model should be &#39;setup&#39; first</span>
<span class="sd">                </span>
<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If model is not properly setup</span>
<span class="sd">        &quot;&quot;&quot;</span>     </div>
    
<div class="viewcode-block" id="AbstractCoreModel.post_process"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.post_process">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">measure_names</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs post processors associated with measures.</span>

<span class="sd">        The model should have previously been prepared using</span>
<span class="sd">        the `setup` method.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (dict):</span>
<span class="sd">                Dictionary of experiment variables - indices</span>
<span class="sd">                are variable names, values are the experiment settings</span>
<span class="sd">            measure_names (List[str]):</span>
<span class="sd">                List of measures to be processed</span>
<span class="sd">            output_path (str):</span>
<span class="sd">                Path to model outputs - if set to none</span>
<span class="sd">                will use local values</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError:</span>
<span class="sd">                If post process is not available for specified</span>
<span class="sd">                measure</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
    
<div class="viewcode-block" id="AbstractCoreModel.load_measures"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.load_measures">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">load_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">measure_names</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">rel_output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">abs_output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import selected measures from the core model.</span>
<span class="sd">        </span>
<span class="sd">        Imports measures from active scenario</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            measure_names (Collection[str]):</span>
<span class="sd">                Collection of measures to be processed</span>
<span class="sd">            rel_output_path, abs_output_path (str, optional):</span>
<span class="sd">                Path to model output locations, either relative</span>
<span class="sd">                to the `model_path` directory (when a subclass</span>
<span class="sd">                is a type that has a model path) or as an absolute</span>
<span class="sd">                directory.  If neither is given, the default</span>
<span class="sd">                value is equivalent to setting `rel_output_path` to</span>
<span class="sd">                &#39;Outputs&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict of measure name and values from active scenario</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If load_measures is not available for specified</span>
<span class="sd">                measure</span>
<span class="sd">        &quot;&quot;&quot;</span>           </div>
        

<div class="viewcode-block" id="AbstractCoreModel.archive"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.archive">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">model_results_path</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies model outputs to archive location</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            params (dict): Dictionary of experiment variables</span>
<span class="sd">            model_results_path (str): archive path</span>
<span class="sd">            experiment_id (int, optional): The id number for this experiment.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="AbstractCoreModel.read_experiments"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.read_experiments">[docs]</a>    <span class="k">def</span> <span class="nf">read_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">only_pending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads results from a design of experiments from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to load.</span>
<span class="sd">            db (Database, optional): The Database from which to read experiments.</span>
<span class="sd">                If no db is given, the default `db` for this model is used.</span>
<span class="sd">            only_pending (bool, default False): If True, only pending</span>
<span class="sd">                experiments (which have no performance measure results</span>
<span class="sd">                stored in the database) are returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If there is no Database connection `db` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no database to read from&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">only_pending</span><span class="o">=</span><span class="n">only_pending</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCoreModel.read_experiment_parameters"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.read_experiment_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">read_experiment_parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">only_pending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads uncertainties and levers from a design of experiments from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to load.</span>
<span class="sd">            db (Database, optional): The Database from which to read experiments.</span>
<span class="sd">                If no db is given, the default `db` for this model is used.</span>
<span class="sd">            only_pending (bool, default False): If True, only pending</span>
<span class="sd">                experiments (which have no performance measure results</span>
<span class="sd">                stored in the database) are returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If `db` is not given and there is no default</span>
<span class="sd">                Database connection set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no database to read from&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">only_pending</span><span class="o">=</span><span class="n">only_pending</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCoreModel.read_experiment_measures"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.read_experiment_measures">[docs]</a>    <span class="k">def</span> <span class="nf">read_experiment_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads performace measures from a design of experiments from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to load.</span>
<span class="sd">            experiment_id (int, optional): The id of the experiment to load.</span>
<span class="sd">            db (Database, optional): The Database from which to read experiment(s).</span>
<span class="sd">                If no db is given, the default `db` for this model is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If `db` is not given and there is no default</span>
<span class="sd">                Database connection set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no database to read from&#39;</span><span class="p">)</span>

        <span class="n">measures</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># only return measures within scope</span>
        <span class="n">measures</span> <span class="o">=</span> <span class="n">measures</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
        
        <span class="k">return</span> <span class="n">measures</span></div>
        

<div class="viewcode-block" id="AbstractCoreModel.ensure_dtypes"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.ensure_dtypes">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert columns of dataframe to correct dtype as needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): A dataframe with column names</span>
<span class="sd">                that are uncertainties, levers, or measures.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                The same data as input, but with dtypes as appropriate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCoreModel.design_experiments"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.design_experiments">[docs]</a>    <span class="k">def</span> <span class="nf">design_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a design of experiments based on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_samples_per_factor (int, default 10): The number of samples in the</span>
<span class="sd">                design per random factor.</span>
<span class="sd">            n_samples (int or tuple, optional): The total number of samples in the</span>
<span class="sd">                design.  If `jointly` is False, this is the number of samples in each</span>
<span class="sd">                of the uncertainties and the levers, the total number of samples will</span>
<span class="sd">                be the square of this value.  Give a 2-tuple to set values for</span>
<span class="sd">                uncertainties and levers respectively, to set them independently.</span>
<span class="sd">                If this argument is given, it overrides `n_samples_per_factor`.</span>
<span class="sd">            random_seed (int or None, default 1234): A random seed for reproducibility.</span>
<span class="sd">            db (Database, optional): If provided, this design will be stored in the</span>
<span class="sd">                database indicated.  If not provided, the `db` for this model will</span>
<span class="sd">                be used, if one is set.</span>
<span class="sd">            design_name (str, optional): A name for this design, to identify it in the</span>
<span class="sd">                database. If not given, a unique name will be generated based on the</span>
<span class="sd">                selected sampler.  Has no effect if no `db` is given.</span>
<span class="sd">            sampler (str or AbstractSampler, default &#39;lhs&#39;): The sampler to use for this</span>
<span class="sd">                design.  Available pre-defined samplers include:</span>
<span class="sd">                    - &#39;lhs&#39;: Latin Hypercube sampling</span>
<span class="sd">                    - &#39;ulhs&#39;: Uniform Latin Hypercube sampling, which ignores defined</span>
<span class="sd">                        distribution shapes from the scope and samples everything</span>
<span class="sd">                        as if it was from a uniform distribution</span>
<span class="sd">                    - &#39;mc&#39;: Monte carlo sampling</span>
<span class="sd">                    - &#39;uni&#39;: Univariate sensitivity testing, whereby experiments are</span>
<span class="sd">                        generated setting each parameter individually to minimum and</span>
<span class="sd">                        maximum values (for numeric dtypes) or all possible values</span>
<span class="sd">                        (for boolean and categorical dtypes).  Note that designs for</span>
<span class="sd">                        univariate sensitivity testing are deterministic and the number</span>
<span class="sd">                        of samples given is ignored.</span>
<span class="sd">            sample_from (&#39;all&#39;, &#39;uncertainties&#39;, or &#39;levers&#39;): Which scope components</span>
<span class="sd">                from which to sample.  Components not sampled are set at their default</span>
<span class="sd">                values in the design.</span>
<span class="sd">            jointly (bool, default True): Whether to sample jointly all uncertainties</span>
<span class="sd">                and levers in a single design, or, if False, to generate separate samples</span>
<span class="sd">                for levers and uncertainties, and then combine the two in a full-factorial</span>
<span class="sd">                manner.  This argument has no effect unless `sample_from` is &#39;all&#39;.</span>
<span class="sd">                Note that jointly may produce a very large design;</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: The resulting design.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;scope&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="kn">from</span> <span class="nn">..experiment</span> <span class="k">import</span> <span class="n">experimental_design</span>
        <span class="k">return</span> <span class="n">experimental_design</span><span class="o">.</span><span class="n">design_experiments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCoreModel.run_experiments"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.run_experiments">[docs]</a>    <span class="k">def</span> <span class="nf">run_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs a design of combined experiments using this model.</span>

<span class="sd">        A combined experiment includes a complete set of input values for</span>
<span class="sd">        all exogenous uncertainties (a Scenario) and all policy levers</span>
<span class="sd">        (a Policy). Unlike the perform_experiments function in the EMA Workbench,</span>
<span class="sd">        this method pairs each Scenario and Policy in sequence, instead</span>
<span class="sd">        of running all possible combinations of Scenario and Policy.</span>
<span class="sd">        This change ensures compatibility with the EMAT database modules, which</span>
<span class="sd">        preserve the complete set of input information (both uncertainties</span>
<span class="sd">        and levers) for each experiment.  To conduct a full cross-factorial set</span>
<span class="sd">        of experiments similar to the default settings for EMA Workbench,</span>
<span class="sd">        use a factorial design, by setting the `jointly` argument for the</span>
<span class="sd">        `design_experiments` to False, or by designing experiments outside</span>
<span class="sd">        of EMAT with your own approach.</span>

<span class="sd">        Args:</span>
<span class="sd">            design (pandas.DataFrame, optional): experiment definitions</span>
<span class="sd">                given as a DataFrame, where each exogenous uncertainties and</span>
<span class="sd">                policy levers is given as a column, and each row is an experiment.</span>
<span class="sd">            evaluator (ema_workbench.Evaluator, optional): Optionally give an</span>
<span class="sd">                evaluator instance.  If not given, a default SequentialEvaluator</span>
<span class="sd">                will be instantiated.</span>
<span class="sd">            design_name (str, optional): The name of a design of experiments to</span>
<span class="sd">                load from the database.  This design is only used if</span>
<span class="sd">                `design` is None.</span>
<span class="sd">            db (Database, optional): The database to use for loading and saving experiments.</span>
<span class="sd">                If none is given, the default database for this model is used.</span>
<span class="sd">                If there is no default db, and none is given here,</span>
<span class="sd">                the results are not stored in a database. Set to False to explicitly</span>
<span class="sd">                not use the default database, even if it exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If there are no experiments defined.  This includes</span>
<span class="sd">                the situation where `design` is given but no database is</span>
<span class="sd">                available.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">ema_workbench</span> <span class="k">import</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">Policy</span><span class="p">,</span> <span class="n">perform_experiments</span>

        <span class="c1"># catch user gives only a design, not experiment_parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">design_name</span><span class="p">,</span> <span class="n">design</span> <span class="o">=</span> <span class="n">design</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;must give design_name or design&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;cannot load design &quot;</span><span class="si">{design_name}</span><span class="s1">&quot;, there is no db&#39;</span><span class="p">)</span>
            <span class="n">design</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">design</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;no experiments available&quot;</span><span class="p">)</span>

        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Scenario</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_get_uncertainty_and_constant_names</span><span class="p">(),</span> <span class="n">i</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">design</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_get_uncertainty_and_constant_names</span><span class="p">()]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ExperimentX&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Policy</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Incognito</span><span class="si">{n}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_lever_names</span><span class="p">(),</span> <span class="n">i</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_lever_names</span><span class="p">()]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ExperimentL&#39;</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">prepare_evaluator</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>
            <span class="n">experiments</span><span class="p">,</span> <span class="n">outcomes</span> <span class="o">=</span> <span class="n">perform_experiments</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">scenarios</span><span class="o">=</span><span class="n">scenarios</span><span class="p">,</span>
                <span class="n">policies</span><span class="o">=</span><span class="n">policies</span><span class="p">,</span>
                <span class="n">zip_over</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scenarios&#39;</span><span class="p">,</span> <span class="s1">&#39;policies&#39;</span><span class="p">},</span>
                <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">experiments</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">design</span><span class="o">.</span><span class="n">index</span>



        <span class="n">outcomes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span>
        <span class="n">outcomes</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">design</span><span class="o">.</span><span class="n">index</span>

        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">)</span>

        <span class="c1"># Put constants back into experiments</span>
        <span class="n">experiments_</span> <span class="o">=</span> <span class="n">experiments</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;policy&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_constants</span><span class="p">():</span>
            <span class="n">experiments_</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">experiments_</span><span class="p">,</span>
            <span class="n">outcomes</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>



<div class="viewcode-block" id="AbstractCoreModel.create_metamodel_from_data"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.create_metamodel_from_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_metamodel_from_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">experiment_inputs</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">experiment_outputs</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">output_transforms</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_measures</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_measures</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_stratification</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">regressor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MetaModel from a set of input and output observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            experiment_inputs (pandas.DataFrame): This dataframe</span>
<span class="sd">                should contain all of the experimental inputs, including</span>
<span class="sd">                values for each uncertainty, level, and constant.</span>
<span class="sd">            experiment_outputs (pandas.DataFrame): This dataframe</span>
<span class="sd">                should contain all of the experimental outputs, including</span>
<span class="sd">                a column for each performance measure. The index</span>
<span class="sd">                for the outputs should match the index for the</span>
<span class="sd">                `experiment_inputs`, so that the I-O matches row-by-row.</span>
<span class="sd">            output_transforms (dict): A mapping of performance measure</span>
<span class="sd">                transforms to use in meta-model estimation and application.</span>
<span class="sd">            metamodel_id (int, optional): An identifier for this meta-model.</span>
<span class="sd">                If not given, a unique id number will be created randomly.</span>
<span class="sd">            include_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names in this set will be included.</span>
<span class="sd">            exclude_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names not in this set will be included.</span>
<span class="sd">            db (Database, optional): The database to use for loading and saving metamodels.</span>
<span class="sd">                If none is given, the default database for this model is used.</span>
<span class="sd">                If there is no default db, and none is given here,</span>
<span class="sd">                the metamodel is not stored in a database.</span>
<span class="sd">            random_state (int, optional): A random state to use in the metamodel</span>
<span class="sd">                regression fitting.</span>
<span class="sd">            experiment_stratification (pandas.Series, optional):</span>
<span class="sd">                A stratification of experiments, used in cross-validation.</span>
<span class="sd">            suppress_converge_warnings (bool, default False):</span>
<span class="sd">                Suppress convergence warnings during metamodel fitting.</span>
<span class="sd">            regressor (Estimator, optional): A scikit-learn estimator implementing a</span>
<span class="sd">                multi-target regression.  If not given, a detrended simple Gaussian</span>
<span class="sd">                process regression is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MetaModel:</span>
<span class="sd">                a callable object that, when called as if a</span>
<span class="sd">                function, accepts keyword arguments as inputs and</span>
<span class="sd">                returns a dictionary of (measure name: value) pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.core_python</span> <span class="k">import</span> <span class="n">PythonCoreModel</span>
        <span class="kn">from</span> <span class="nn">.meta_model</span> <span class="k">import</span> <span class="n">MetaModel</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">experiment_inputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metamodel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span>
                <span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_new_metamodel_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="mi">63</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_transforms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_transforms</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">include_measures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="n">experiment_outputs</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">include_measures</span>
                                                     <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
            <span class="n">output_transforms</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">output_transforms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">include_measures</span>
                                 <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_transforms</span> <span class="p">}</span>
            
        <span class="k">if</span> <span class="n">exclude_measures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">exclude_measures</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">exclude_measures</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">output_transforms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">disabled_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="n">func</span> <span class="o">=</span> <span class="n">MetaModel</span><span class="p">(</span>
            <span class="n">experiment_inputs</span><span class="p">,</span>
            <span class="n">experiment_outputs</span><span class="p">,</span>
            <span class="n">output_transforms</span><span class="p">,</span>
            <span class="n">disabled_outputs</span><span class="p">,</span>
            <span class="n">random_state</span><span class="p">,</span>
            <span class="n">experiment_stratification</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="n">suppress_converge_warnings</span><span class="p">,</span>
            <span class="n">regressor</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">scope_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">duplicate</span><span class="p">(</span><span class="n">strip_measure_transforms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                      <span class="n">include_measures</span><span class="o">=</span><span class="n">include_measures</span><span class="p">,</span>
                                      <span class="n">exclude_measures</span><span class="o">=</span><span class="n">exclude_measures</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PythonCoreModel</span><span class="p">(</span>
            <span class="n">func</span><span class="p">,</span>
            <span class="n">configuration</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">scope_</span><span class="p">,</span>
            <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;Meta&quot;</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCoreModel.create_metamodel_from_design"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.create_metamodel_from_design">[docs]</a>    <span class="k">def</span> <span class="nf">create_metamodel_from_design</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">regressor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MetaModel from a set of input and output observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to use.</span>
<span class="sd">            metamodel_id (int, optional): An identifier for this meta-model.</span>
<span class="sd">                If not given, a unique id number will be created randomly.</span>
<span class="sd">            include_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names in this set will be included.</span>
<span class="sd">            exclude_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names not in this set will be included.</span>
<span class="sd">            random_state (int, optional): A random state to use in the metamodel</span>
<span class="sd">                regression fitting.</span>
<span class="sd">            suppress_converge_warnings (bool, default False):</span>
<span class="sd">                Suppress convergence warnings during metamodel fitting.</span>
<span class="sd">            regressor (Estimator, optional): A scikit-learn estimator implementing a</span>
<span class="sd">                multi-target regression.  If not given, a detrended simple Gaussian</span>
<span class="sd">                process regression is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MetaModel:</span>
<span class="sd">                a callable object that, when called as if a</span>
<span class="sd">                function, accepts keyword arguments as inputs and</span>
<span class="sd">                returns a dictionary of (measure name: value) pairs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the named design still has pending experiments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check_df</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">only_pending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">..exceptions</span> <span class="k">import</span> <span class="n">PendingExperimentsError</span>
                <span class="k">raise</span> <span class="n">PendingExperimentsError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;design &quot;</span><span class="si">{design_name}</span><span class="s1">&quot; has pending experiments&#39;</span><span class="p">)</span>

        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
        <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>

        <span class="n">transforms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">metamodeltype</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metamodel_from_data</span><span class="p">(</span>
            <span class="n">experiment_inputs</span><span class="p">,</span>
            <span class="n">experiment_outputs</span><span class="p">,</span>
            <span class="n">transforms</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="n">include_measures</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="n">exclude_measures</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="n">suppress_converge_warnings</span><span class="p">,</span>
            <span class="n">regressor</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCoreModel.create_metamodel_from_designs"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.create_metamodel_from_designs">[docs]</a>    <span class="k">def</span> <span class="nf">create_metamodel_from_designs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_names</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MetaModel from multiple sets of input and output observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_names (Collection[str]): The names of the designs to use.</span>
<span class="sd">            metamodel_id (int, optional): An identifier for this meta-model.</span>
<span class="sd">                If not given, a unique id number will be created randomly.</span>
<span class="sd">            include_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names in this set will be included.</span>
<span class="sd">            exclude_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names not in this set will be included.</span>
<span class="sd">            random_state (int, optional): A random state to use in the metamodel</span>
<span class="sd">                regression fitting.</span>
<span class="sd">            suppress_converge_warnings (bool, default False):</span>
<span class="sd">                Suppress convergence warnings during metamodel fitting.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MetaModel:</span>
<span class="sd">                a callable object that, when called as if a</span>
<span class="sd">                function, accepts keyword arguments as inputs and</span>
<span class="sd">                returns a dictionary of (measure name: value) pairs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the named design still has pending experiments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
                <span class="n">check_df</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">only_pending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">..exceptions</span> <span class="k">import</span> <span class="n">PendingExperimentsError</span>
                    <span class="k">raise</span> <span class="n">PendingExperimentsError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;design &quot;</span><span class="si">{design_name}</span><span class="s1">&quot; has pending experiments&#39;</span><span class="p">)</span>

        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;_design_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_name</span>
            <span class="n">experiment_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">experiment_inputs</span><span class="p">)</span>

        <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span>  <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
            <span class="c1"># f[&#39;_design_&#39;] = design_name</span>
            <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">experiment_outputs</span><span class="p">)</span>

        <span class="n">transforms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">metamodeltype</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metamodel_from_data</span><span class="p">(</span>
            <span class="n">experiment_inputs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_design_&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">experiment_outputs</span><span class="p">,</span>
            <span class="n">transforms</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="n">include_measures</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="n">exclude_measures</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">experiment_stratification</span><span class="o">=</span><span class="n">experiment_inputs</span><span class="p">[</span><span class="s1">&#39;_design_&#39;</span><span class="p">],</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="n">suppress_converge_warnings</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.feature_scores"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.feature_scores">[docs]</a>    <span class="k">def</span> <span class="nf">feature_scores</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design</span><span class="p">,</span>
            <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;styled&#39;</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate feature scores based on a design of experiments.</span>

<span class="sd">        Args:</span>
<span class="sd">            design (str or pandas.DataFrame): The name of the design of experiments</span>
<span class="sd">                to use for feature scoring, or a single pandas.DataFrame containing the</span>
<span class="sd">                experimental design and results.</span>
<span class="sd">            return_type ({&#39;styled&#39;, &#39;figure&#39;, &#39;dataframe&#39;}):</span>
<span class="sd">                The format to return, either a heatmap figure as an SVG render in and</span>
<span class="sd">                xmle.Elem, or a plain pandas.DataFrame, or a styled dataframe.</span>
<span class="sd">            random_state (int or numpy.RandomState, optional):</span>
<span class="sd">                Random state to use.</span>
<span class="sd">            cmap (string or colormap, default &#39;viridis&#39;): matplotlib colormap</span>
<span class="sd">                to use for rendering.</span>

<span class="sd">        Returns:</span>
<span class="sd">            xmle.Elem or pandas.DataFrame:</span>
<span class="sd">                Returns a rendered SVG as xml, or a DataFrame,</span>
<span class="sd">                depending on the `return_type` argument.</span>

<span class="sd">        This function internally uses feature_scoring from the EMA Workbench, which in turn</span>
<span class="sd">        scores features using the &quot;extra trees&quot; regression approach.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">..analysis.feature_scoring</span> <span class="k">import</span> <span class="n">feature_scores</span>
        <span class="k">return</span> <span class="n">feature_scores</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="n">design</span><span class="p">,</span>
            <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="n">get_feature_scores</span> <span class="o">=</span> <span class="n">feature_scores</span> <span class="c1"># for compatability with prior versions of TMIP-EMAT</span>

    <span class="k">def</span> <span class="nf">_common_optimization_setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">display_convergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epsilons</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">epsilons</span> <span class="o">=</span> <span class="p">[</span><span class="n">epsilons</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcomes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">convergence</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">convergence</span> <span class="o">=</span> <span class="n">ConvergenceMetrics</span><span class="p">(</span>
                <span class="n">EpsilonProgress</span><span class="p">(),</span>
                <span class="n">SolutionCount</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">display_convergence</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">convergence</span><span class="p">,</span> <span class="n">ConvergenceMetrics</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span>
            <span class="n">display</span><span class="p">(</span><span class="n">convergence</span><span class="p">)</span>

        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">prepare_evaluator</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">epsilons</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">evaluator</span>

<div class="viewcode-block" id="AbstractCoreModel.optimize"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.optimize">[docs]</a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">searchover</span><span class="o">=</span><span class="s1">&#39;levers&#39;</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">display_convergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reverse_targets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="n">min_epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">check_extremes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform multi-objective optimization over levers or uncertainties.</span>

<span class="sd">        The targets for the multi-objective optimization (i.e. whether each</span>
<span class="sd">        individual performance measures is to be maximized or minimized) are</span>
<span class="sd">        read from the model&#39;s scope.</span>

<span class="sd">        Args:</span>
<span class="sd">            searchover ({&#39;levers&#39;, &#39;uncertainties&#39;}):</span>
<span class="sd">                Which group of inputs to search over.  The other group</span>
<span class="sd">                will be set at their default values, unless other values</span>
<span class="sd">                are provided in the `reference` argument.</span>
<span class="sd">            evaluator (Evaluator, optional): The evaluator to use to</span>
<span class="sd">                run the model. If not given, a SequentialEvaluator will</span>
<span class="sd">                be created.</span>
<span class="sd">            nfe (int, default 10_000): Number of function evaluations.</span>
<span class="sd">                This generally needs to be fairly large to achieve stable</span>
<span class="sd">                results in all but the most trivial applications.</span>
<span class="sd">            convergence (&#39;default&#39;, None, or emat.optimization.ConvergenceMetrics):</span>
<span class="sd">                A convergence display during optimization.  The default</span>
<span class="sd">                value is to report the epsilon-progress (the number of</span>
<span class="sd">                solutions that ever enter the candidate pool of non-dominated</span>
<span class="sd">                solutions) and the number of solutions remaining in that candidate</span>
<span class="sd">                pool.  Pass `None` explicitly to disable convergence tracking.</span>
<span class="sd">            display_convergence (bool, default True): Whether to automatically</span>
<span class="sd">                display figures that dynamically track convergence.  Set to</span>
<span class="sd">                `False` if you are not using this method within a Jupyter</span>
<span class="sd">                interactive environment.</span>
<span class="sd">            convergence_freq (int, default 100): How frequently to update the</span>
<span class="sd">                convergence measures.  There is some computational overhead to</span>
<span class="sd">                these convergence updates, so setting a value too small may</span>
<span class="sd">                noticeably slow down the process.</span>
<span class="sd">            constraints (Collection[Constraint], optional):</span>
<span class="sd">                Solutions will be constrained to only include values that</span>
<span class="sd">                satisfy these constraints. The constraints can be based on</span>
<span class="sd">                the search parameters (levers or uncertainties, depending on the</span>
<span class="sd">                value given for `searchover`), or performance measures, or</span>
<span class="sd">                some combination thereof.</span>
<span class="sd">            reference (Mapping): A set of values for the non-active inputs,</span>
<span class="sd">                i.e. the uncertainties if `searchover` is &#39;levers&#39;, or the</span>
<span class="sd">                levers if `searchover` is &#39;uncertainties&#39;.  Any values not</span>
<span class="sd">                set here revert to the default values identified in the scope.</span>
<span class="sd">            reverse_targets (bool, default False): Whether to reverse the</span>
<span class="sd">                optimization targets given in the scope (i.e., changing</span>
<span class="sd">                minimize to maximize, or vice versa).  This will result in</span>
<span class="sd">                the optimization searching for the worst outcomes, instead of</span>
<span class="sd">                the best outcomes.</span>
<span class="sd">            algorithm (platypus.Algorithm, optional): Select an</span>
<span class="sd">                algorithm for multi-objective optimization.  The default</span>
<span class="sd">                algorithm is EpsNSGAII. See `platypus` documentation for details.</span>
<span class="sd">            epsilons (float or array-like): Used to limit the number of</span>
<span class="sd">                distinct solutions generated.  Set to a larger value to get</span>
<span class="sd">                fewer distinct solutions.</span>
<span class="sd">            cache_dir (path-like, optional): A directory in which to</span>
<span class="sd">                cache results.  Most of the arguments will be hashed</span>
<span class="sd">                to develop a unique filename for these results, making this</span>
<span class="sd">                generally safer than `cache_file`.</span>
<span class="sd">            cache_file (path-like, optional): A file into which to</span>
<span class="sd">                cache results.  If this file exists, the contents of the</span>
<span class="sd">                file will be loaded and all other arguments are ignored.</span>
<span class="sd">                Use with great caution.</span>
<span class="sd">            kwargs: Any additional arguments will be passed on to the</span>
<span class="sd">                platypus algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            emat.OptimizationResult:</span>
<span class="sd">                The set of non-dominated solutions found.</span>
<span class="sd">                When `convergence` is given, the convergence measures are</span>
<span class="sd">                included, as a pandas.DataFrame in the `convergence` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">..util.disk_cache</span> <span class="k">import</span> <span class="n">load_cache_if_available</span><span class="p">,</span> <span class="n">save_cache</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ema_workbench</span> <span class="k">import</span> <span class="n">Policy</span><span class="p">,</span> <span class="n">Scenario</span>
            <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">Scenario</span><span class="p">):</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="s2">&quot;ReferenceScenario&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">reference</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;uncertainties&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">Policy</span><span class="p">):</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">Policy</span><span class="p">(</span><span class="s2">&quot;ReferencePolicy&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">default_scenario</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;uncertainties&#39;</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">default_policy</span><span class="p">()</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">cache_file</span> <span class="o">=</span> <span class="n">load_cache_if_available</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="n">cache_file</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">searchover</span><span class="o">=</span><span class="n">searchover</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
            <span class="n">reverse_targets</span><span class="o">=</span><span class="n">reverse_targets</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsilons</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">evaluator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_optimization_setup</span><span class="p">(</span>
                <span class="n">epsilons</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">evaluator</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">reverse_targets</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">():</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">kind_original</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">kind</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">kind</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">epsilons</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">ema_workbench</span> <span class="k">import</span> <span class="n">perform_experiments</span>
                        <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">trial_outcomes</span> <span class="o">=</span> <span class="n">perform_experiments</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="n">scenarios</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                                <span class="n">policies</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">trial_outcomes</span> <span class="o">=</span> <span class="n">perform_experiments</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="n">scenarios</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                <span class="n">policies</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                                <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="n">epsilons</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">min_epsilon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trial_outcomes</span><span class="p">[</span><span class="n">mn</span><span class="p">])</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">mn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()]</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                        <span class="n">searchover</span><span class="o">=</span><span class="n">searchover</span><span class="p">,</span>
                        <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                        <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                        <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
                        <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
                        <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">,</span> <span class="n">result_convergence</span> <span class="o">=</span> <span class="n">results</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result_convergence</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Put constants back in to results</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_constants</span><span class="p">():</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">OptimizationResult</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">result_convergence</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">reference</span>
                    <span class="k">elif</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;uncertainties&#39;</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="n">reference</span>

                    <span class="k">if</span> <span class="n">check_extremes</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">check_extremes</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="k">if</span> <span class="n">check_extremes</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">check_extremes</span><span class="p">,</span>
                            <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                            <span class="n">searchover</span><span class="o">=</span><span class="n">searchover</span><span class="p">,</span>
                            <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reverse_targets</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">():</span>
                        <span class="n">k</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">kind_original</span>
                        <span class="k">del</span> <span class="n">k</span><span class="o">.</span><span class="n">kind_original</span>


        <span class="k">elif</span> <span class="n">display_convergence</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_optimization_setup</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convergence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">x</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">save_cache</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="AbstractCoreModel.robust_optimize"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.robust_optimize">[docs]</a>    <span class="k">def</span> <span class="nf">robust_optimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">robustness_functions</span><span class="p">,</span>
            <span class="n">scenarios</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">display_convergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">check_extremes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform robust optimization.</span>

<span class="sd">        The robust optimization generally a multi-objective optimization task.</span>
<span class="sd">        It is undertaken using statistical measures of outcomes evaluated across</span>
<span class="sd">        a number of scenarios, instead of using the individual outcomes themselves.</span>
<span class="sd">        For each candidate policy, the model is evaluated against all of the considered</span>
<span class="sd">        scenarios, and then the robustness measures are evaluated using the</span>
<span class="sd">        set of outcomes from the original runs.  The robustness measures</span>
<span class="sd">        are aggregate measures that are computed from a set of outcomes.</span>
<span class="sd">        For example, this may be expected value, median, n-th percentile,</span>
<span class="sd">        minimum, or maximum value of any individual outcome.  It is also</span>
<span class="sd">        possible to have joint measures, e.g. expected value of the larger</span>
<span class="sd">        of outcome 1 or outcome 2.</span>

<span class="sd">        Each robustness function is indicated as a maximization or minimization</span>
<span class="sd">        target, where higher or lower values are better, respectively.</span>
<span class="sd">        The optimization process then tries to identify one or more</span>
<span class="sd">        non-dominated solutions for the possible policy levers.</span>

<span class="sd">        Args:</span>
<span class="sd">            robustness_functions (Collection[Measure]): A collection of</span>
<span class="sd">                aggregate statistical performance measures.</span>
<span class="sd">            scenarios (int or Collection): A collection of scenarios to</span>
<span class="sd">                use in the evaluation(s), or give an integer to generate</span>
<span class="sd">                that number of random scenarios.</span>
<span class="sd">            evaluator (Evaluator, optional): The evaluator to use to</span>
<span class="sd">                run the model. If not given, a SequentialEvaluator will</span>
<span class="sd">                be created.</span>
<span class="sd">            nfe (int, default 10_000): Number of function evaluations.</span>
<span class="sd">                This generally needs to be fairly large to achieve stable</span>
<span class="sd">                results in all but the most trivial applications.</span>
<span class="sd">            convergence (&#39;default&#39;, None, or emat.optimization.ConvergenceMetrics):</span>
<span class="sd">                A convergence display during optimization.</span>
<span class="sd">            display_convergence (bool, default True): Automatically display</span>
<span class="sd">                the convergence metric figures when optimizing.</span>
<span class="sd">            convergence_freq (int, default 100): The frequency at which</span>
<span class="sd">                convergence metric figures are updated.</span>
<span class="sd">            constraints (Collection[Constraint], optional)</span>
<span class="sd">                Solutions will be constrained to only include values that</span>
<span class="sd">                satisfy these constraints. The constraints can be based on</span>
<span class="sd">                the policy levers, or on the computed values of the robustness</span>
<span class="sd">                functions, or some combination thereof.</span>
<span class="sd">            epsilons (float or array-like): Used to limit the number of</span>
<span class="sd">                distinct solutions generated.  Set to a larger value to get</span>
<span class="sd">                fewer distinct solutions.</span>
<span class="sd">            cache_dir (path-like, optional): A directory in which to</span>
<span class="sd">                cache results.  Most of the arguments will be hashed</span>
<span class="sd">                to develop a unique filename for these results, making this</span>
<span class="sd">                generally safer than `cache_file`.</span>
<span class="sd">            cache_file (path-like, optional): A file into which to</span>
<span class="sd">                cache results.  If this file exists, the contents of the</span>
<span class="sd">                file will be loaded and all other arguments are ignored.</span>
<span class="sd">                Use with great caution.</span>
<span class="sd">            algorithm (platypus.Algorithm or str, optional): Select an</span>
<span class="sd">                algorithm for multi-objective optimization.  The algorithm can</span>
<span class="sd">                be given directly, or named in a string. See `platypus`</span>
<span class="sd">                documentation for details.</span>
<span class="sd">            check_extremes (bool or int, default False): Conduct additional</span>
<span class="sd">                evaluations, setting individual policy levers to their</span>
<span class="sd">                extreme values, for each candidate Pareto optimal solution.</span>
<span class="sd">            kwargs: any additional arguments will be passed on to the</span>
<span class="sd">                platypus algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            emat.OptimizationResult:</span>
<span class="sd">                The set of non-dominated solutions found.</span>
<span class="sd">                When `convergence` is given, the convergence measures are</span>
<span class="sd">                included, as a pandas.DataFrame in the `convergence` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">..optimization.optimize</span> <span class="k">import</span> <span class="n">robust_optimize</span>

        <span class="kn">from</span> <span class="nn">..util.disk_cache</span> <span class="k">import</span> <span class="n">load_cache_if_available</span><span class="p">,</span> <span class="n">save_cache</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">cache_file</span> <span class="o">=</span> <span class="n">load_cache_if_available</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="n">cache_file</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">scenarios</span><span class="o">=</span><span class="n">scenarios</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
            <span class="n">robustness_functions</span><span class="o">=</span><span class="n">robustness_functions</span><span class="p">,</span>
            <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
            <span class="n">check_extremes</span><span class="o">=</span><span class="n">check_extremes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">robust_optimize</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">robustness_functions</span><span class="p">,</span>
                <span class="n">scenarios</span><span class="p">,</span>
                <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
                <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
                <span class="n">display_convergence</span><span class="o">=</span><span class="n">display_convergence</span><span class="p">,</span>
                <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
                <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
                <span class="n">check_extremes</span><span class="o">=</span><span class="n">check_extremes</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">display_convergence</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_optimization_setup</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convergence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">result</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">save_cache</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="AbstractCoreModel.robust_evaluate"><a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.robust_evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">robust_evaluate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">robustness_functions</span><span class="p">,</span>
            <span class="n">scenarios</span><span class="p">,</span>
            <span class="n">policies</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform robust evaluation(s).</span>

<span class="sd">        The robust evaluation is used to generate statistical measures</span>
<span class="sd">        of outcomes, instead of generating the individual outcomes themselves.</span>
<span class="sd">        For each policy, the model is evaluated against all of the considered</span>
<span class="sd">        scenarios, and then the robustness measures are evaluated using the</span>
<span class="sd">        set of outcomes from the original runs.  The robustness measures</span>
<span class="sd">        are aggregate measures that are computed from a set of outcomes.</span>
<span class="sd">        For example, this may be expected value, median, n-th percentile,</span>
<span class="sd">        minimum, or maximum value of any individual outcome.  It is also</span>
<span class="sd">        possible to have joint measures, e.g. expected value of the larger</span>
<span class="sd">        of outcome 1 or outcome 2.</span>

<span class="sd">        Args:</span>
<span class="sd">            robustness_functions (Collection[Measure]): A collection of</span>
<span class="sd">                aggregate statistical performance measures.</span>
<span class="sd">            scenarios (int or Collection): A collection of scenarios to</span>
<span class="sd">                use in the evaluation(s), or give an integer to generate</span>
<span class="sd">                that number of random scenarios.</span>
<span class="sd">            policies (int, or collection): A collection of policies to</span>
<span class="sd">                use in the evaluation(s), or give an integer to generate</span>
<span class="sd">                that number of random policies.</span>
<span class="sd">            evaluator (Evaluator, optional): The evaluator to use to</span>
<span class="sd">                run the model. If not given, a SequentialEvaluator will</span>
<span class="sd">                be created.</span>
<span class="sd">            cache_dir (path-like, optional): A directory in which to</span>
<span class="sd">                cache results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: The computed value of each item</span>
<span class="sd">                in `robustness_functions`, for each policy in `policies`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">robust_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">..util.hasher</span> <span class="k">import</span> <span class="n">hash_it</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">hash_it</span><span class="p">(</span>
                    <span class="n">scenarios</span><span class="p">,</span>
                    <span class="n">policies</span><span class="p">,</span>
                    <span class="n">robustness_functions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span><span class="n">hh</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span><span class="n">hh</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span><span class="n">hh</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span><span class="n">hh</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">hh</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;loading from cache_file=</span><span class="si">{cache_file}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">..util.filez</span> <span class="k">import</span> <span class="n">load</span>
                    <span class="n">robust_results</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span>
                    <span class="n">cache_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">traceback</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unable to manage cache&#39;</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">robust_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evaluator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">ema_workbench.em_framework</span> <span class="k">import</span> <span class="n">SequentialEvaluator</span>
                <span class="n">evaluator</span> <span class="o">=</span> <span class="n">SequentialEvaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">BaseEvaluator</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="k">import</span> <span class="n">Client</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
                    <span class="kn">from</span> <span class="nn">ema_workbench.em_framework.ema_distributed</span> <span class="k">import</span> <span class="n">DistributedEvaluator</span>
                    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">DistributedEvaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">evaluator</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">ema_workbench.em_framework.samplers</span> <span class="k">import</span> <span class="n">sample_uncertainties</span><span class="p">,</span> <span class="n">sample_levers</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scenarios</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">n_scenarios</span> <span class="o">=</span> <span class="n">scenarios</span>
                <span class="n">scenarios</span> <span class="o">=</span> <span class="n">sample_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_scenarios</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>
                <span class="n">robust_results</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">robust_evaluate</span><span class="p">(</span>
                    <span class="n">robustness_functions</span><span class="p">,</span>
                    <span class="n">scenarios</span><span class="p">,</span>
                    <span class="n">policies</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">robust_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">robust_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cache_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..util.filez</span> <span class="k">import</span> <span class="n">save</span>
            <span class="n">save</span><span class="p">(</span><span class="n">robust_results</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">,</span><span class="s1">&#39;.info.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">notes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scenarios=&quot;</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;robustness_functions=&quot;</span><span class="p">,</span> <span class="n">robustness_functions</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;policies=&quot;</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">robust_results</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>