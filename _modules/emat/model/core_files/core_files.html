

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>emat.model.core_files.core_files &mdash; TMIP-EMAT 0.3.2, September 2020 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/tmip_emat.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/jupyter-sphinx.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> TMIP-EMAT
          

          
          </a>

          
            
            
              <div class="version">
                0.3.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.intro.html">Introduction to EMAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.install.html">Installation and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.scope/index.html">Exploratory Scoping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.models/index.html">Core Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.metamodels/index.html">Meta Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.database/index.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">TMIP-EMAT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>emat.model.core_files.core_files</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for emat.model.core_files.core_files</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span><span class="p">,</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">...model.core_model</span> <span class="kn">import</span> <span class="n">AbstractCoreModel</span>
<span class="kn">from</span> <span class="nn">...scope.scope</span> <span class="kn">import</span> <span class="n">Scope</span>
<span class="kn">from</span> <span class="nn">...database.database</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">...util.docstrings</span> <span class="kn">import</span> <span class="n">copydoc</span>
<span class="kn">from</span> <span class="nn">...exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.parsers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">...util.loggers</span> <span class="kn">import</span> <span class="n">get_module_logger</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">get_module_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">copy_model_outputs_1</span><span class="p">(</span>
		<span class="n">local_model</span><span class="p">,</span>
		<span class="n">remote_repository</span><span class="p">,</span>
		<span class="n">file</span>
<span class="p">):</span>
	<span class="n">copyfile</span><span class="p">(</span>
		<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_model</span><span class="p">,</span> <span class="s2">&quot;Outputs&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
		<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_repository</span><span class="p">,</span> <span class="s2">&quot;Outputs&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
	<span class="p">)</span>

<span class="k">def</span> <span class="nf">copy_model_outputs_ext</span><span class="p">(</span>
		<span class="n">local_model</span><span class="p">,</span>
		<span class="n">remote_repository</span><span class="p">,</span>
		<span class="n">basename</span><span class="p">,</span>
		<span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;.bin&#39;</span><span class="p">,</span> <span class="s1">&#39;.dcb&#39;</span><span class="p">)</span>
<span class="p">):</span>
	<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">:</span>
		<span class="n">copy_model_outputs_1</span><span class="p">(</span>
			<span class="n">local_model</span><span class="p">,</span>
			<span class="n">remote_repository</span><span class="p">,</span>
			<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span>
		<span class="p">)</span>

<span class="n">ALL</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="FilesCoreModel"><a class="viewcode-back" href="../../../../source/emat.models/files-api.html#emat.model.FilesCoreModel">[docs]</a><span class="k">class</span> <span class="nc">FilesCoreModel</span><span class="p">(</span><span class="n">AbstractCoreModel</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Setup connections and paths to a file reading core model</span>

<span class="sd">	Args:</span>
<span class="sd">		configuration:</span>
<span class="sd">			The configuration for this</span>
<span class="sd">			core model. This can be passed as a dict, or as a str</span>
<span class="sd">			which gives the filename of a YAML file that will be</span>
<span class="sd">			loaded.</span>
<span class="sd">		scope:</span>
<span class="sd">			The exploration scope, as a Scope object or as</span>
<span class="sd">			a str which gives the filename of a YAML file that will be</span>
<span class="sd">			loaded.</span>
<span class="sd">		safe:</span>
<span class="sd">			Load the configuration YAML file in &#39;safe&#39; mode.</span>
<span class="sd">			This can be disabled if the configuration requires</span>
<span class="sd">			custom Python types or is otherwise not compatible with</span>
<span class="sd">			safe mode. Loading configuration files with safe mode</span>
<span class="sd">			off is not secure and should not be done with files from</span>
<span class="sd">			untrusted sources.</span>
<span class="sd">		db:</span>
<span class="sd">			An optional Database to store experiments and results.</span>
<span class="sd">		name:</span>
<span class="sd">			A name for this model, given as an alphanumeric string.</span>
<span class="sd">			The name is required by ema_workbench operations.</span>
<span class="sd">			If not given, &quot;FilesCoreModel&quot; is used.</span>
<span class="sd">		local_directory:</span>
<span class="sd">			Optionally explicitly give this local_directory to use,</span>
<span class="sd">			overriding any directory set in the config file. If not</span>
<span class="sd">			given either here or in the config file, then Python&#39;s</span>
<span class="sd">			cwd is used.</span>


<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
				 <span class="n">configuration</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">],</span>
				 <span class="n">scope</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Scope</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
				 <span class="n">safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
				 <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
				 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FilesCoreModel&#39;</span><span class="p">,</span>
				 <span class="n">local_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
				 <span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
			<span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
			<span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span>
			<span class="n">safe</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span>
			<span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
			<span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
			<span class="n">metamodel_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
		<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">local_directory</span> <span class="o">=</span> <span class="n">local_directory</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_directory&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
		<span class="sd">&quot;&quot;&quot;Path: The current local working directory for this model.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">])</span>
		<span class="sd">&quot;&quot;&quot;Path: The directory of the &#39;live&#39; model instance, relative to the local_directory.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">rel_output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rel_output_path&#39;</span><span class="p">,</span> <span class="s1">&#39;Outputs&#39;</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;Path: The path to &#39;live&#39; model outputs, relative to `model_path`.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_archive&#39;</span><span class="p">])</span>
		<span class="sd">&quot;&quot;&quot;Path: The directory where archived models are stored.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_short_circuit&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;Bool: Allow model runs to be skipped if measures already appear in the database.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">ignore_crash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ignore_crash&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;Bool: Allow model runs to continue to `post_process` and `archive` even after an apparent crash in `run`.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">success_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success_indicator&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;str: optional, The name of a file that indicates the model has run successfully.  </span>
<span class="sd">		</span>
<span class="sd">		This file is deleted automatically when the model `run` is initiated.&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">resolved_model_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		The model path to use.</span>

<span class="sd">		If `model_path` is set to an absolute path, then that path is returned,</span>
<span class="sd">		otherwise the `model_path` is joined onto the `local_directory`.</span>

<span class="sd">		Returns:</span>
<span class="sd">			str</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">MissingModelPathError</span><span class="p">(</span><span class="s1">&#39;no archive set for this core model&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">resolved_archive_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		The archive path to use.</span>

<span class="sd">		If `archive_path` is set to an absolute path, then that path is returned,</span>
<span class="sd">		otherwise the `archive_path` is joined onto the `local_directory`.</span>

<span class="sd">		Returns:</span>
<span class="sd">			str</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">MissingArchivePathError</span><span class="p">(</span><span class="s1">&#39;no archive set for this core model&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>

<div class="viewcode-block" id="FilesCoreModel.add_parser"><a class="viewcode-back" href="../../../../source/emat.models/files-api.html#emat.model.FilesCoreModel.add_parser">[docs]</a>	<span class="k">def</span> <span class="nf">add_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add a FileParser to extract performance measures.</span>

<span class="sd">		Args:</span>
<span class="sd">			parser (FileParser): The parser to add.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">FileParser</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;parser must be an instance of FileParser&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilesCoreModel.get_parser"><a class="viewcode-back" href="../../../../source/emat.models/files-api.html#emat.model.FilesCoreModel.get_parser">[docs]</a>	<span class="k">def</span> <span class="nf">get_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Access a FileParser, used to extract performance measures.</span>

<span class="sd">		Args:</span>
<span class="sd">			idx (int): The position of the parser to get.</span>

<span class="sd">		Returns:</span>
<span class="sd">			FileParser</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>

	<span class="k">def</span> <span class="nf">model_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">model_init</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs an experiment through core model.</span>

<span class="sd">		This method overloads the `run_model` method given in</span>
<span class="sd">		the EMA Workbench, and provides the correct execution</span>
<span class="sd">		of a core model within the workbench framework.  This</span>
<span class="sd">		function assembles and executes the steps laid out in</span>
<span class="sd">		other methods of this class, adding some useful logic</span>
<span class="sd">		to optimize the process (e.g. optionally short-</span>
<span class="sd">		circuiting runs that already have results stored</span>
<span class="sd">		in the database).</span>

<span class="sd">		For each experiment, the core model is called to:</span>

<span class="sd">			1.  `setup` experiment variables, copy files</span>
<span class="sd">			    as needed, and otherwise prepare to run the</span>
<span class="sd">			    core model for a particular experiment,</span>
<span class="sd">			2.  `run` the experiment,</span>
<span class="sd">			3.  `post_process` the result if needed to</span>
<span class="sd">			    produce all relevant performance measures,</span>
<span class="sd">			4.  `archive` model outputs from this experiment</span>
<span class="sd">			    (optional), and</span>
<span class="sd">			5.  `load_measures` from the experiment and</span>
<span class="sd">			    store those measures in the associated database.</span>

<span class="sd">		Note that this method does *not* return any outcomes.</span>
<span class="sd">		Outcomes are instead written into self.outcomes_output,</span>
<span class="sd">		and can be retrieved from there, or from the database at</span>
<span class="sd">		a later time.</span>

<span class="sd">		In general, it should not be necessary to overload this</span>
<span class="sd">		method in derived classes built for particular core models.</span>
<span class="sd">		Instead, write overloaded methods for `setup`, `run`,</span>
<span class="sd">		`post_process` , `archive`, and `load_measures`.  Moreover,</span>
<span class="sd">		in typical usage a modeler will generally not want to rely</span>
<span class="sd">		on this method directly, but instead use `run_experiments`</span>
<span class="sd">		to automatically run multiple experiments with one command.</span>

<span class="sd">		Args:</span>
<span class="sd">			scenario (Scenario): A dict-like object that</span>
<span class="sd">				has key-value pairs for each uncertainty.</span>
<span class="sd">			policy (Policy): A dict-like object that</span>
<span class="sd">				has key-value pairs for each lever.</span>

<span class="sd">		Raises:</span>
<span class="sd">			UserWarning: If there are no experiments associated with</span>
<span class="sd">				this type.</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;run_core_model read_experiment_parameters&quot;</span><span class="p">)</span>

		<span class="n">experiment_id</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiment_id_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">experiment_id</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiment_id_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_db&#39;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_sqlitedb_path&#39;</span><span class="p">):</span>
			<span class="kn">from</span> <span class="nn">...database.sqlite.sqlite_db</span> <span class="kn">import</span> <span class="n">SQLiteDB</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">SQLiteDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlitedb_path</span><span class="p">)</span>

		<span class="c1"># If running a core files model using the DistributedEvaluator,</span>
		<span class="c1"># the workers won&#39;t have access to the DB directly, so we&#39;ll only</span>
		<span class="c1"># run the short-circuit test and the ad-hoc write-to-database</span>
		<span class="c1"># section of this code if the `db` attribute is available.</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

			<span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">read_experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span><span class="p">:</span>
				<span class="c1"># opportunity to short-circuit run by loading pre-computed values.</span>
				<span class="n">precomputed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
					<span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
					<span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">precomputed</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">outcomes_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">precomputed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="k">return</span>

			<span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_experiment_parameters_1</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ad hoc&#39;</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">policy</span>
				<span class="p">)</span>

		<span class="n">xl</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">xl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
		<span class="n">xl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

		<span class="n">m_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>

		<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model setup </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_indicator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">success_indicator</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_model_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_indicator</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">success_indicator</span><span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">success_indicator</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">success_indicator</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model run </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
		<span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR in run_core_model run </span><span class="si">{experiment_id}</span><span class="s2">: {str(err)}&quot;</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">ex_archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_archive_path</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">makedirs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">MissingArchivePathError</span><span class="p">:</span>
				<span class="k">pass</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
					<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_archive_path</span><span class="p">,</span> <span class="s1">&#39;error.stdout.log&#39;</span><span class="p">),</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
						<span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
					<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_archive_path</span><span class="p">,</span> <span class="s1">&#39;error.stderr.log&#39;</span><span class="p">),</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
						<span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_archive_path</span><span class="p">,</span> <span class="s1">&#39;error.log&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">errlog</span><span class="p">:</span>
					<span class="n">errlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
			<span class="n">measures_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">m_names</span><span class="p">}</span>
			<span class="c1"># Assign to outcomes_output, for ema_workbench compatibility</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">outcomes_output</span> <span class="o">=</span> <span class="n">measures_dictionary</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_crash</span><span class="p">:</span>
				<span class="c1"># If &#39;ignore_crash&#39; is False (the default), then abort now and skip</span>
				<span class="c1"># any post-processing and other archiving steps, which will</span>
				<span class="c1"># probably fail anyway.</span>
				<span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model ABORT </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model CONTINUE AFTER ERROR </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">success_indicator</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">success_indicator</span><span class="p">):</span>
				<span class="c1"># The absence of the `success_indicator` file means that the model</span>
				<span class="c1"># did not actually terminate correctly, so we do not want to</span>
				<span class="c1"># post-process or store these results in the database.</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;success_indicator missing: </span><span class="si">{success_indicator}</span><span class="s2">&quot;</span><span class="p">)</span>

			<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model post_process </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">m_names</span><span class="p">)</span>

			<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model wrap up </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">measures_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_measures</span><span class="p">(</span><span class="n">m_names</span><span class="p">)</span>
			<span class="n">m_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">measures_dictionary</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">experiment_id</span><span class="p">])</span>

			<span class="c1"># Assign to outcomes_output instead of returning them, for ema_workbench compatibility</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">outcomes_output</span> <span class="o">=</span> <span class="n">measures_dictionary</span>
		<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KeyboardInterrupt in post_process, load_measures or outcome processing </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">raise</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error in post_process, load_measures or outcome processing </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;proceeding directly to archive attempt </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># only write to database if there was no error in post_process, load_measures or outcome processing</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model write db </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span><span class="p">,</span> <span class="n">m_df</span><span class="p">)</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="n">ex_archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_archive_path</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">MissingArchivePathError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model archive </span><span class="si">{experiment_id}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">ex_archive_path</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">)</span>

	<span class="nd">@copydoc</span><span class="p">(</span><span class="n">AbstractCoreModel</span><span class="o">.</span><span class="n">get_experiment_archive_path</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">get_experiment_archive_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">makedirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must give `experiment_id` or `parameters`&quot;</span><span class="p">)</span>
			<span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
					<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">MissingIdWarning</span><span class="p">)</span>
					<span class="n">experiment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
		<span class="n">mod_results_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">resolved_archive_path</span><span class="p">,</span>
			<span class="sa">f</span><span class="s2">&quot;scp_</span><span class="si">{self.scope.name}</span><span class="s2">&quot;</span><span class="p">,</span>
			<span class="sa">f</span><span class="s2">&quot;exp_</span><span class="si">{experiment_id}</span><span class="s2">&quot;</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="n">makedirs</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mod_results_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mod_results_path</span>

	<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
		<span class="n">scope_param_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">())</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scope_param_names</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{key}</span><span class="s2">&#39; not found in scope parameters&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FilesCoreModel.load_measures"><a class="viewcode-back" href="../../../../source/emat.models/files-api.html#emat.model.FilesCoreModel.load_measures">[docs]</a>	<span class="nd">@copydoc</span><span class="p">(</span><span class="n">AbstractCoreModel</span><span class="o">.</span><span class="n">load_measures</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">load_measures</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span>
			<span class="n">measure_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
			<span class="o">*</span><span class="p">,</span>
			<span class="n">rel_output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
			<span class="n">abs_output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>

		<span class="k">if</span> <span class="n">rel_output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">abs_output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot give both `rel_output_path` and `abs_output_path`&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">rel_output_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">abs_output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_model_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_output_path</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">rel_output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_model_path</span><span class="p">,</span> <span class="n">rel_output_path</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># abs_output_path is not None</span>
			<span class="n">output_path</span> <span class="o">=</span> <span class="n">abs_output_path</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">measure_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">is_requested</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">requested_measure_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">measure_names</span><span class="p">)</span>
			<span class="n">is_requested</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">requested_measure_names</span>

		<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

		<span class="k">for</span> <span class="n">parser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_requested</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">measure_names</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">measures</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">measure_names</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">is_requested</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
							<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> unavailable, </span><span class="si">{err}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">measure_names</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">is_requested</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
							<span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> unavailable, </span><span class="si">{err!r}</span><span class="s1">&#39;</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">is_requested</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
							<span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

		<span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="FilesCoreModel.load_archived_measures"><a class="viewcode-back" href="../../../../source/emat.models/files-api.html#emat.model.FilesCoreModel.load_archived_measures">[docs]</a>	<span class="k">def</span> <span class="nf">load_archived_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span> <span class="n">measure_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Load performance measures from an archived model run.</span>

<span class="sd">		Args:</span>
<span class="sd">			experiment_id (int): The id for the experiment to load.</span>
<span class="sd">			measure_names (Collection, optional): A subset of</span>
<span class="sd">				performance measure names to load.  If not provided,</span>
<span class="sd">				all measures will be loaded.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">experiment_archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_archive_path</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">)</span>
		<span class="n">experiment_archive_zip</span> <span class="o">=</span> <span class="n">experiment_archive_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.zip&quot;</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">experiment_archive_zip</span><span class="p">):</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;zipped archive found, loading from </span><span class="si">{experiment_archive_zip}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">zipfile</span>
			<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
				<span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">experiment_archive_zip</span><span class="p">)</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_measures</span><span class="p">(</span>
					<span class="n">measure_names</span><span class="p">,</span>
					<span class="n">abs_output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
						<span class="n">tmpdir</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">rel_output_path</span><span class="p">,</span>
					<span class="p">)</span>
				<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loading from </span><span class="si">{experiment_archive_path}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_measures</span><span class="p">(</span>
				<span class="n">measure_names</span><span class="p">,</span>
				<span class="n">abs_output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
					<span class="n">experiment_archive_path</span><span class="p">,</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">rel_output_path</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">model_results_path</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">NotImplementedError</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">NotImplementedError</span>

	<span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">measure_names</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Runs post processors associated with particular performance measures.</span>

<span class="sd">		This method is the place to conduct automatic post-processing</span>
<span class="sd">		of core model run results, in particular any post-processing that</span>
<span class="sd">		is expensive or that will write new output files into the core model&#39;s</span>
<span class="sd">		output directory.  The core model run should already have</span>
<span class="sd">		been completed using `setup` and `run`.  If the relevant performance</span>
<span class="sd">		measures do not require any post-processing to create (i.e. they</span>
<span class="sd">		can all be read directly from output files created during the core</span>
<span class="sd">		model run itself) then this method does not need to be overloaded</span>
<span class="sd">		for a particular core model implementation.</span>

<span class="sd">		The default implementation of this method is a no-op, but it is</span>
<span class="sd">		available to be overloaded for particular implementations.</span>

<span class="sd">		Args:</span>
<span class="sd">			params (dict):</span>
<span class="sd">				Dictionary of experiment variables, with keys as variable names</span>
<span class="sd">				and values as the experiment settings. Most post-processing</span>
<span class="sd">				scripts will not need to know the particular values of the</span>
<span class="sd">				inputs (exogenous uncertainties and policy levers), but this</span>
<span class="sd">				method receives the experiment input parameters as an argument</span>
<span class="sd">				in case one or more of these parameter values needs to be known</span>
<span class="sd">				in order to complete the post-processing.</span>
<span class="sd">			measure_names (List[str]):</span>
<span class="sd">				List of measures to be processed.  Normally for the first pass</span>
<span class="sd">				of core model run experiments, post-processing will be completed</span>
<span class="sd">				for all performance measures.  However, it is possible to use</span>
<span class="sd">				this argument to give only a subset of performance measures to</span>
<span class="sd">				post-process, which may be desirable if the post-processing</span>
<span class="sd">				of some performance measures is expensive.  Additionally, this</span>
<span class="sd">				method may also be called on archived model results, allowing</span>
<span class="sd">				it to run to generate only a subset of (probably new) performance</span>
<span class="sd">				measures based on these archived runs.</span>
<span class="sd">			output_path (str, optional):</span>
<span class="sd">				Path to model outputs.  If this is not given (typical for the</span>
<span class="sd">				initial run of core model experiments) then the local/default</span>
<span class="sd">				model directory is used.  This argument is provided primarily</span>
<span class="sd">				to facilitate post-processing archived model runs to make new</span>
<span class="sd">				performance measures (i.e. measures that were not in-scope when</span>
<span class="sd">				the core model was actually run).</span>

<span class="sd">		Raises:</span>
<span class="sd">			KeyError:</span>
<span class="sd">				If post process is not available for specified measure</span>
<span class="sd">		&quot;&quot;&quot;</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>